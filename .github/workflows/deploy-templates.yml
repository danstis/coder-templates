name: Deploy Templates to Coder

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (leave empty for latest)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Coder
    runs-on: ubuntu-latest
    # Only run if Coder secrets are configured
    if: vars.CODER_DEPLOY_ENABLED == 'true'
    
    steps:
      - name: Determine release tag
        id: release
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          elif [[ -n "${{ inputs.release_tag }}" ]]; then
            echo "tag=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
          else
            # Fetch latest release tag
            LATEST=$(curl -sL https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
            echo "tag=$LATEST" >> $GITHUB_OUTPUT
          fi

      - name: Download release assets
        run: |
          mkdir -p dist
          RELEASE_TAG="${{ steps.release.outputs.tag }}"
          echo "Downloading assets from release: $RELEASE_TAG"
          
          # Get asset URLs from the release
          ASSETS=$(curl -sL "https://api.github.com/repos/${{ github.repository }}/releases/tags/$RELEASE_TAG" \
            | jq -r '.assets[] | select(.name | endswith(".zip")) | .browser_download_url')
          
          if [[ -z "$ASSETS" ]]; then
            echo "::error::No template zips found in release $RELEASE_TAG"
            exit 1
          fi
          
          # Download each asset
          for url in $ASSETS; do
            echo "Downloading: $url"
            curl -sL "$url" -o "dist/$(basename $url)"
          done
          
          echo "Downloaded assets:"
          ls -la dist/

      - name: Install Coder CLI
        run: |
          curl -fsSL https://coder.com/install.sh | sh
          coder version

      - name: Deploy templates
        env:
          CODER_URL: ${{ secrets.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_SESSION_TOKEN }}
        run: |
          RELEASE_TAG="${{ steps.release.outputs.tag }}"
          
          # Verify Coder connection
          echo "Connecting to Coder at: $CODER_URL"
          coder whoami
          
          # Deploy each template
          for zip in dist/*.zip; do
            template_name=$(basename "$zip" .zip)
            template_dir="dist/${template_name}_extracted"
            
            echo "=========================================="
            echo "Deploying template: $template_name"
            echo "=========================================="
            
            # Extract the zip
            mkdir -p "$template_dir"
            unzip -q "$zip" -d "$template_dir"
            
            # Push to Coder
            # --yes bypasses confirmation prompts
            # --name sets version name for traceability
            # --message provides context in the Coder UI
            coder templates push "$template_name" \
              --directory "$template_dir" \
              --name "$RELEASE_TAG" \
              --message "Deployed from GitHub release $RELEASE_TAG" \
              --yes
            
            echo "Successfully deployed: $template_name"
          done

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Coder URL:** ${{ secrets.CODER_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Templates Deployed" >> $GITHUB_STEP_SUMMARY
          for zip in dist/*.zip; do
            echo "- $(basename "$zip" .zip)" >> $GITHUB_STEP_SUMMARY
          done
